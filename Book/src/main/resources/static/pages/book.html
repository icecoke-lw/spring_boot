<!DOCTYPE html>
<html>
  <head>
    <!-- 页面meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>图书管理系统</title>
    <meta
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
      name="viewport"
    />
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../plugins/elementui/index.css" />
    <link
      rel="stylesheet"
      href="../plugins/font-awesome/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="../css/style.css" />
  </head>

  <body class="hold-transition">
    <div id="ap" style="margin-left: 100px;margin-right: 100px">
      <div class="content-header">
        <h1>图书管理系统</h1>
      </div>

      <div class="app-container">
        <div class="box">
          <div class="filter-container">
            <el-input
              placeholder="书名"
              v-model="name"
              style="width: 200px"
              class="filter-item"
            ></el-input>
            <el-button @click="handleLike(name)" class="dalfBut">查询</el-button>
            <el-button type="primary" class="butT" @click="handleCreate()"
              >添加</el-button
            >
          </div>


            <el-table
                    size="small"
                    current-row-key="id"
                    :data="dataList"
                    stripe
                    highlight-current-row
            >
                <el-table-column type="index" align="center" label="序号"></el-table-column>
                <el-table-column
                        prop="id"
                        align="center"
                        label="书籍编号"
                ></el-table-column>

                <el-table-column
                        prop="name"
                        label="书籍名称"
                        align="center"
                ></el-table-column>

                <el-table-column
                        prop="author"
                        label="作者"
                        align="center"
                ></el-table-column>

                <el-table-column
                        prop="press"
                        label="出版社"
                        align="center"
                ></el-table-column>
                <el-table-column
                        prop="category"
                        label="所属学科"
                        align="center"
                ></el-table-column>

                <el-table-column label="操作" align="center">
                    <template slot-scope="scope">
                        <el-button
                                type="primary"
                                size="mini"
                                @click="handleUpdate(scope.row)"
                        >编辑</el-button
                        >

                        <el-button
                                type="danger"
                                size="mini"
                                @click="handleDelete(scope.row)"
                        >删除</el-button
                        >
                    </template>
                </el-table-column>
            </el-table>

          <!-- 新增标签弹层 -->
          <div class="add-form">
            <el-dialog title="新增书籍" :visible.sync="dialogFormVisible" width="35%">
              <el-form
                ref="dataAddForm"
                :model="formData"
                :rules="rules"
                label-position="right"
                label-width="85px"
              >
                <el-row>
                  <el-col :span="24">
                    <el-form-item label="书名" prop="name">
                      <el-input v-model="formData.name"/>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row>
                  <el-col :span="24">
                    <el-form-item label="作者" prop="author">
                      <el-input v-model="formData.author" />
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row>
                  <el-col :span="24">
                    <el-form-item label="出版社" prop="press">
                      <el-input v-model="formData.press" />
                    </el-form-item>
                  </el-col>
                </el-row>
                  <el-row>
                  <el-col :span="24">
                    <el-form-item label="所属学科" prop="category">
                      <el-input v-model="formData.category" />
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-form>

              <div slot="footer" class="dialog-footer">
                <el-button @click="cancel()">取消</el-button>

                <el-button type="primary" @click="handleAdd()">添加</el-button>
              </div>
            </el-dialog>
          </div>

          <!-- 编辑标签弹层 -->

          <div class="add-form">
            <el-dialog title="编辑信息" :visible.sync="dialogFormVisible4Edit" width="35%">
              <el-form
                ref="dataEditForm"
                :model="formData"
                :rules="rules"
                label-position="right"
                label-width="85px"
              >


                <el-row>
                  <el-col :span="24">
                    <el-form-item label="书名" prop="name">
                      <el-input v-model="formData.name" />
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row>
                  <el-col :span="24">
                    <el-form-item label="作者" prop="author">
                      <el-input v-model="formData.author" />
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row>
                  <el-col :span="24">
                    <el-form-item label="出版社" prop="press">
                      <el-input v-model="formData.press" />
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row>
                  <el-col :span="24">
                    <el-form-item label="所属学科" prop="category">
                      <el-input v-model="formData.category" />
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-form>

              <div slot="footer" class="dialog-footer">
                <el-button @click="cancel()">取消</el-button>

                <el-button type="primary" @click="handleEdit()">确定</el-button>
              </div>
            </el-dialog>
          </div>
        </div>
      </div>
    </div>
  </body>

  <!-- 引入组件库 -->

  <script src="../js/vue.js"></script>

  <script src="../plugins/elementui/index.js"></script>

  <script type="text/javascript" src="../js/jquery.min.js"></script>

  <script src="../js/axios-0.18.0.js"></script>

  <script>
    var vue = new Vue({
      el: "#ap",
      data: {
        dataList: [], //当前页要展示的列表数据
        dialogFormVisible: false, //添加表单是否可见
        dialogFormVisible4Edit: false, //编辑表单是否可见
        formData: {}, //表单数据
        rules: {
          //校验规则
          name: [
            { required: true, message: "书名不能为空", trigger: "blur" },
          ],
          author: [
            { required: true, message: "作者不能为空", trigger: "blur" },
          ],
          press: [
            { required: true, message: "出版社不能为空", trigger: "blur" },
          ],
          category: [
            { required: true, message: "所属学科不能为空", trigger: "blur" },
          ],
        },
        name:"",
      },
      //VUE对象初始化完成后自动执行
      created() {
        //调用查询全部数据的操作
        this.getAll();
      },
      methods: {
        //书籍列表
        getAll() {
          axios.get("/book").then((res)=>{
            console.log(res.data);
            this.dataList=res.data.data;
          })
        },
        //弹出添加窗口
        handleCreate() {
           this.dialogFormVisible = true;
           this.resetForm();
        },
        //重置表单
        resetForm() {
          this.formData = {};
        },

        //添加
        handleAdd() {
          axios.post("/book", this.formData).then((res) => {
              //判断当前操作是否成功
              if (res.data.flag) {
                //1.关闭弹层
                this.dialogFormVisible = false;
                this.$message.success(res.data.msg);
              } else {
                this.$message.error(res.data.msg);
              }
            })
            .finally(() => {
              //2.重新加载数据
              this.getAll();
            });
        },

        //取消
        cancel() {
          this.dialogFormVisible = false;
          this.dialogFormVisible4Edit = false;
          this.$message.info("当前操作取消");
        },
        // 删除
        handleDelete(row) {
          console.log(row);
          this.$confirm("此操作永久删除当前信息，是否继续？", "提示", {type: "info",}).then(() => {
            axios.delete("/book/" + row.id).then((res) => {
                   if (res.data.flag) {
                     this.$message.success("删除成功");
                   } else {
                     this.$message.error("数据同步失败，自动刷新");
                   }
                 }).finally(() => {
                   //2.重新加载数据
                   this.getAll();
                 });
             }).catch(() => {
               this.$message.info("取消操作");
             });
        },
        //弹出编辑窗口
        handleUpdate(row) {
          console.log(row);
              axios.get("/book/id/"+row.id).then((res) => {
                if(res.data.flag &&res.data.data!=null) {
                  this.dialogFormVisible4Edit = true;
                  this.formData = res.data.data;
                }else{
                  this.$message.error("数据同步失败，自动刷新");
                }
             })
        },

        //修改
        handleEdit() {
            axios.put("/book", this.formData).then((res) => {
                //判断当前操作是否成功
                if (res.data.flag) {
                  //1.关闭弹层
                  this.dialogFormVisible4Edit = false;
                  this.$message.success("修改成功");
                } else {
                  this.$message.error("修改失败");
                }
              }).finally(() => {
                //2.重新加载数据
                this.getAll();
              });
        },

        //模糊查询
        handleLike(name) {
          axios.get("/book/"+name).then((res) => {
            //判断当前操作是否成功
            if (res.data.flag) {
              console.log("查询成功")
              this.dataList=res.data.data;
            } else {
              console.log("查询失败")
            }
          })
        },
      },
    });
  </script>
</html>
